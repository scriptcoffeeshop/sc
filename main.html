<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咖啡豆訂購</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/tw-city-selector@2.1.1/dist/tw-city-selector.min.js"></script>
</head>

<body class="p-4 md:p-6">

    <!-- 公告 -->
    <div id="announcement-banner"
        class="hidden max-w-3xl mx-auto mb-4 p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-900 relative">
        <button data-action="close-announcement"
            class="absolute top-2 right-3 text-amber-500 hover:text-amber-700 text-xl">&times;</button>
        <p id="announcement-text" class="pr-6"></p>
    </div>

    <div class="max-w-3xl mx-auto glass-card p-6 md:p-8">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-6">
            <span class="text-4xl" id="site-icon">☕</span>
            <div>
                <h1 class="text-2xl font-bold" style="color:var(--primary)" id="site-title">咖啡豆訂購</h1>
                <p class="text-sm text-gray-500" id="site-subtitle">新鮮烘焙・產地直送</p>
            </div>
        </div>

        <!-- LINE Login -->
        <div id="login-section" class="mb-6 p-4 rounded-xl" style="background:#f0faf0; border:1px solid #c8e6c9;">
            <div id="login-prompt" class="text-center">
                <p class="text-gray-600 mb-3">請先使用 LINE 帳號登入以進行訂購</p>
                <button data-action="login-with-line"
                    class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
                    </svg>
                    使用 LINE 登入
                </button>
            </div>
            <div id="user-info" class="hidden flex items-center gap-3">
                <img id="user-avatar" src="" alt="" class="w-12 h-12 rounded-full border-2 border-green-300">
                <div class="flex-1">
                    <p class="text-sm text-gray-500">已登入</p>
                    <p id="user-display-name" class="font-semibold text-gray-700"></p>
                </div>
                <button data-action="show-my-orders" class="text-sm font-medium" style="color:var(--primary)">📋
                    我的訂單</button>
                <button data-action="logout" class="text-sm text-gray-500 hover:text-red-500">登出</button>
            </div>
        </div>
        <input type="hidden" id="line-name">

        <!-- 動態表單欄位 -->
        <div id="dynamic-fields-container"></div>

        <!-- 商品列表 -->
        <div class="mb-6">
            <h2 class="text-lg font-bold mb-4" style="color:var(--primary)" id="products-section-title">🪶 咖啡豆選購</h2>
            <div id="products-container">
                <p class="text-center text-gray-500 py-8">載入商品中...</p>
            </div>
        </div>

        <!-- 配送方式 -->
        <div class="mb-6">
            <h2 class="text-lg font-bold mb-4" style="color:var(--primary)" id="delivery-section-title">🚚 配送方式</h2>
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4" id="delivery-options-list">
                <!-- 由 JS 動態產生，依據 delivery_options_config -->
            </div>

            <!-- 配送到府地址 (限竹北/新竹) -->
            <div id="delivery-address-section" class="hidden fade-in p-4 rounded-xl"
                style="background:#faf6f2; border:1px solid #e5ddd5;">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">📍 配送地址 (限新竹市/竹北市)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">縣市</label>
                        <select id="delivery-city" class="input-field" onchange="updateDistricts()">
                            <option value="">請選擇</option>
                            <option value="新竹市">新竹市</option>
                            <option value="竹北市">竹北市</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">區域</label>
                        <select id="delivery-district" class="input-field">
                            <option value="">請先選擇縣市</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">詳細地址</label>
                    <input type="text" id="delivery-detail-address" class="input-field" placeholder="路/街、巷、弄、號、樓">
                </div>
            </div>

            <!-- 全台宅配地址 -->
            <div id="home-delivery-section" class="hidden fade-in p-4 rounded-xl"
                style="background:#f4f1ee; border:1px solid #dcd3cb;">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">📦 全台宅配地址</h3>

                <!-- tw-city-selector 容器 -->
                <div role="tw-city-selector" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">縣市 <span class="text-red-500">*</span></label>
                        <select class="county input-field"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">區域 <span class="text-red-500">*</span></label>
                        <select class="district input-field"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">郵遞區號</label>
                        <input class="zipcode input-field bg-gray-100" type="text" readonly placeholder="自動帶入">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">詳細地址 <span class="text-red-500">*</span></label>
                    <input type="text" id="home-delivery-detail" class="input-field" placeholder="路/街、巷、弄、號、樓">
                </div>
            </div>

            <!-- 超商取貨 -->
            <div id="store-pickup-section" class="hidden fade-in p-4 rounded-xl"
                style="background:#f0faf0; border:1px solid #c8e6c9;">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">🏪 取貨門市資訊</h3>
                <div class="mb-3 text-center">
                    <button data-action="open-store-map" class="store-select-btn">📍 選擇門市</button>
                    <p class="text-xs text-gray-500 mt-1">點擊後將開啟超商地圖選擇門市</p>
                </div>
                <div id="store-selected-info" class="hidden store-info-card mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold" id="selected-store-name"></p>
                            <p class="text-sm text-gray-600" id="selected-store-address"></p>
                            <p class="text-xs text-gray-400" id="selected-store-id"></p>
                        </div>
                        <button data-action="clear-selected-store" class="text-sm text-red-500 hover:text-red-700">✕
                            清除</button>
                    </div>
                </div>
                <input type="hidden" id="store-name-input">
                <input type="hidden" id="store-address-input">
                <input type="hidden" id="store-id-input">
            </div>

            <!-- 來店取貨資訊 -->
            <div id="in-store-section" class="hidden fade-in p-4 rounded-xl"
                style="background:#fefdf8; border:1px solid #f0e6db; margin-top: 1rem;">
                <h3 class="font-semibold mb-3 text-gray-800">🏪 門市資訊</h3>
                <p class="text-sm text-gray-700 leading-relaxed mb-3">
                    <strong>地址：</strong>新竹市東區建中路101號1樓<br>
                    <strong>電話：</strong><a href="tel:035718460" class="hover:underline text-blue-600">03-5718460</a><br>
                    <strong>官方 LINE：</strong><a href="https://lin.ee/aEiCEfh" target="_blank"
                        class="hover:underline text-green-600 font-medium">@scriptcoffee</a> <span
                        class="text-xs text-gray-500">(點擊加入官方 LINE 帳號)</span><br>
                    <strong>營業時間：</strong>請以 Google 商家地圖上顯示的時間為準
                </p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <a href="https://maps.app.goo.gl/emnxgDhm3mRhCz5o7" target="_blank"
                        class="inline-block text-sm font-medium hover:opacity-80 transition-opacity"
                        style="color:var(--primary); text-decoration:underline;">
                        📍 去 Google Maps 查看路線和營業時間
                    </a>
                </div>
            </div>
        </div>

        <!-- 付款方式 -->
        <div id="payment-method-section" class="mb-6 fade-in">
            <h2 class="text-lg font-bold mb-4" style="color:var(--primary)" id="payment-section-title">💳 付款方式</h2>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-4" id="payment-options">
                <div class="payment-option active" id="cod-option" data-action="select-payment" data-method="cod">
                    <div class="check-mark">✓</div>
                    <div class="text-2xl mb-2" id="po-cod-icon-display">💵</div>
                    <div class="font-semibold" id="po-cod-name-display">取件 / 到付</div>
                    <div class="text-xs text-gray-500 mt-1" id="po-cod-desc-display">取貨時付現或宅配到付</div>
                </div>
                <div class="payment-option hidden" id="linepay-option" data-action="select-payment"
                    data-method="linepay">
                    <div class="check-mark">✓</div>
                    <div class="text-2xl mb-2" id="po-linepay-icon-display">💚</div>
                    <div class="font-semibold text-[#06C755]" id="po-linepay-name-display">LINE Pay</div>
                    <div class="text-xs text-gray-500 mt-1" id="po-linepay-desc-display">線上安全付款</div>
                </div>
                <div class="payment-option hidden" id="transfer-option" data-action="select-payment"
                    data-method="transfer">
                    <div class="check-mark">✓</div>
                    <div class="text-2xl mb-2" id="po-transfer-icon-display">🏦</div>
                    <div class="font-semibold text-blue-600" id="po-transfer-name-display">線上轉帳</div>
                    <div class="text-xs text-gray-500 mt-1" id="po-transfer-desc-display">ATM / 網銀匯款</div>
                </div>
            </div>

            <!-- 線上轉帳資訊 -->
            <div id="transfer-info-section" class="hidden fade-in p-4 rounded-xl"
                style="background:#f0f5fa; border:1px solid #c8d6e5;">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">🏦 匯款資訊</h3>

                <!-- 新增應付金額顯示 -->
                <div class="mb-3 p-3 bg-white rounded-lg border border-blue-100 flex justify-between items-center">
                    <span class="text-sm text-gray-600">應匯款總金額</span>
                    <span class="text-lg font-bold text-blue-600" id="transfer-total-amount">$0</span>
                </div>

                <div id="bank-accounts-list" class="mb-3"></div>
                <div class="mt-3">
                    <label class="block text-sm text-gray-600 mb-1">您的匯款帳號末 5 碼（供對帳用）</label>
                    <input type="text" id="transfer-last5" class="input-field" placeholder="請輸入帳號末5碼" maxlength="5"
                        pattern="\d{5}" inputmode="numeric">
                </div>
            </div>
        </div>

        <!-- 備註 -->
        <div class="mb-6">
            <label class="block font-medium mb-2" style="color:var(--primary)" id="notes-section-title">📝 訂單備註</label>
            <textarea id="order-note" class="input-field resize-none" rows="2" placeholder="如有特殊需求請在此備註..."></textarea>
        </div>

        <div class="content-spacer"></div>
    </div>

    <!-- 底部固定欄 -->
    <div class="bottom-bar">
        <div class="w-full max-w-3xl mx-auto flex items-center justify-between">
            <div class="text-xl font-bold" style="color:var(--primary)" id="total-price">總金額: $0</div>
            <div class="flex gap-2">
                <button data-action="toggle-cart"
                    class="relative bg-amber-50 border-2 border-amber-200 text-amber-800 px-4 py-3 rounded-xl font-semibold text-sm hover:bg-amber-100 transition-colors">
                    🛒 購物車 <span id="cart-badge"
                        class="hidden ml-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">0</span>
                </button>
                <!-- 幽靈按鈕：防止舊版快取 JS 找不到物件而引發報錯 -->
                <button id="submit-btn" style="display:none;"></button>
            </div>
        </div>
    </div>

    <!-- 購物車 Drawer -->
    <div id="cart-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60]" data-action="toggle-cart"></div>
    <div id="cart-drawer"
        class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-[61] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b flex justify-between items-center" style="border-color:#f0e6db;">
            <h3 class="text-lg font-bold" style="color:var(--primary)">🛒 購物車</h3>
            <button data-action="toggle-cart" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4">
            <p class="text-center text-gray-400 py-8">購物車是空的</p>
        </div>
        <div class="p-4 border-t" style="border-color:#f0e6db; background:#faf6f2;">
            <div id="cart-discount-details" class="mb-3 text-sm text-gray-600 hidden"></div>
            <div class="flex justify-between items-center mb-3">
                <span class="font-semibold text-gray-700">合計</span>
                <span id="cart-total" class="text-xl font-bold" style="color:var(--primary)">$0</span>
            </div>
            <button data-action="submit-order" class="btn-primary w-full" id="cart-submit-btn">確認送出訂單</button>
        </div>
    </div>

    <!-- 我的訂單彈窗 -->
    <div id="my-orders-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" style="color:var(--primary)">📋 我的訂單</h3>
                <button data-action="close-orders-modal"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="my-orders-list" class="flex-1 overflow-y-auto p-4"></div>
        </div>
    </div>

    <script type="module" src="js/main-app.js?v=23"></script>
</body>

</html>