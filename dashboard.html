<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡è¨‚è³¼ â€” å¾Œå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #3C2415;
            --secondary: #D4A574;
            --accent: #8B6914;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #F5F0EB, #E8DDD4);
            min-height: 100vh;
            margin: 0;
            color: #3C2415;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(60, 36, 21, 0.12);
            border: 1px solid rgba(212, 165, 116, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3C2415, #5C3D2E);
            color: white;
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(60, 36, 21, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(60, 36, 21, 0.4);
        }

        .tab-active {
            background: linear-gradient(135deg, #3C2415, #5C3D2E) !important;
            color: white !important;
        }

        .input-field {
            border: 2px solid #e5ddd5;
            border-radius: 10px;
            padding: 10px 14px;
            width: 100%;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(60, 36, 21, 0.1);
            outline: none;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            padding: 16px 24px;
            box-shadow: 0 -4px 24px rgba(60, 36, 21, 0.1);
            z-index: 50;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-processing {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-shipped {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-completed {
            background: #E5E7EB;
            color: #374151;
        }

        .status-cancelled {
            background: #FEE2E2;
            color: #991B1B;
        }

        .delivery-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .delivery-delivery {
            background: #FEF3C7;
            color: #92400E;
        }

        .delivery-seven_eleven {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .delivery-family_mart {
            background: #D1FAE5;
            color: #065F46;
        }

        .content-spacer {
            height: 80px;
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <!-- ç™»å…¥é  -->
    <div id="login-page" class="max-w-md mx-auto mt-20 glass-card p-8 text-center">
        <span class="text-5xl block mb-4">â˜•</span>
        <h1 class="text-2xl font-bold mb-2" style="color:var(--primary)">å’–å•¡è¨‚è³¼å¾Œå°</h1>
        <p class="text-gray-500 mb-6">åƒ…é™ç®¡ç†å“¡ç™»å…¥</p>
        <button onclick="loginWithLine()"
            class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
            </svg>
            ä½¿ç”¨ LINE ç™»å…¥
        </button>
    </div>

    <!-- ç®¡ç†é  -->
    <div id="admin-page" class="hidden max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">â˜•</span>
                <div>
                    <h1 class="text-xl font-bold" style="color:var(--primary)">å’–å•¡è¨‚è³¼å¾Œå°</h1>
                    <p class="text-sm text-gray-500">æ­¡è¿ï¼Œ<span id="admin-name"></span></p>
                </div>
            </div>
            <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500">ç™»å‡º</button>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button id="tab-orders" onclick="showTab('orders')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">ğŸ“‹
                è¨‚å–®ç®¡ç†</button>
            <button id="tab-products" onclick="showTab('products')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">ğŸ«˜
                å•†å“ç®¡ç†</button>
            <button id="tab-categories" onclick="showTab('categories')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">ğŸ“‚
                åˆ†é¡ç®¡ç†</button>
            <button id="tab-settings" onclick="showTab('settings')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">âš™ï¸
                ç³»çµ±è¨­å®š</button>
            <button id="tab-users" onclick="showTab('users')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">ğŸ‘¥
                ç”¨æˆ¶ç®¡ç†</button>
            <button id="tab-blacklist" onclick="showTab('blacklist')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">ğŸš«
                é»‘åå–®</button>
        </div>

        <!-- ===== è¨‚å–®ç®¡ç† ===== -->
        <div id="orders-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">è¨‚å–®åˆ—è¡¨</h2>
                <div class="flex gap-2 items-center">
                    <select id="order-filter" class="input-field text-sm py-1" style="width:auto"
                        onchange="renderOrders()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="pending">å¾…è™•ç†</option>
                        <option value="processing">è™•ç†ä¸­</option>
                        <option value="shipped">å·²å‡ºè²¨</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                    <button onclick="loadOrders()" class="text-sm" style="color:var(--primary)">ğŸ”„ é‡æ•´</button>
                </div>
            </div>
            <div id="orders-list">
                <p class="text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- ===== å•†å“ç®¡ç† ===== -->
        <div id="products-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">å’–å•¡è±†å•†å“</h2>
                <button onclick="showProductModal()" class="btn-primary text-sm">+ æ–°å¢å•†å“</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left" style="color:var(--primary)">åˆ†é¡</th>
                            <th class="p-3 text-left" style="color:var(--primary)">å“å</th>
                            <th class="p-3 text-right" style="color:var(--primary)">åƒ¹æ ¼</th>
                            <th class="p-3 text-center" style="color:var(--primary)">ç‹€æ…‹</th>
                            <th class="p-3 text-center" style="color:var(--primary)">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== åˆ†é¡ç®¡ç† ===== -->
        <div id="categories-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">å•†å“åˆ†é¡</h2>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-cat-name" class="input-field flex-grow" placeholder="æ–°åˆ†é¡åç¨±">
                <button onclick="addCategory()" class="btn-primary text-sm">æ–°å¢</button>
            </div>
            <div id="categories-list"></div>
        </div>

        <!-- ===== ç”¨æˆ¶ç®¡ç† ===== -->
        <div id="users-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">ç”¨æˆ¶ç®¡ç†</h2>
                <div class="flex gap-2 items-center">
                    <input type="text" id="user-search" class="input-field text-sm py-1" placeholder="æœå°‹åç¨±/æ‰‹æ©Ÿ/Email"
                        onkeyup="if(event.key==='Enter') loadUsers()">
                    <button onclick="loadUsers()" class="btn-primary text-sm py-1 px-4">æœå°‹</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left w-12" style="color:var(--primary)">é ­åƒ</th>
                            <th class="p-3 text-left" style="color:var(--primary)">ç”¨æˆ¶è³‡è¨Š</th>
                            <th class="p-3 text-left" style="color:var(--primary)">è§’è‰²èˆ‡ç‹€æ…‹</th>
                            <th class="p-3 text-right" style="color:var(--primary)">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr>
                            <td colspan="4" class="text-center py-8 text-gray-500">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== é»‘åå–® ===== -->
        <div id="blacklist-section" class="glass-card p-6 hidden">
            <h2 class="text-lg font-bold mb-4" style="color:var(--primary)">é»‘åå–®</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left" style="color:var(--primary)">ç”¨æˆ¶åç¨±</th>
                            <th class="p-3 text-left" style="color:var(--primary)">å°é–æ™‚é–“èˆ‡åŸå› </th>
                            <th class="p-3 text-right" style="color:var(--primary)">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="blacklist-table">
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== ç³»çµ±è¨­å®š ===== -->
        <div id="settings-section" class="glass-card p-6 hidden">
            <h2 class="text-lg font-bold mb-6" style="color:var(--primary)">ç³»çµ±è¨­å®š</h2>
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">ğŸ“¢ å…¬å‘Šè¨­å®š</h3>
                <label class="flex items-center gap-2 mb-3 cursor-pointer">
                    <input type="checkbox" id="s-ann-enabled" class="w-4 h-4"> <span>å•Ÿç”¨å…¬å‘Š</span>
                </label>
                <textarea id="s-announcement" class="input-field resize-none" rows="3" placeholder="å…¬å‘Šå…§å®¹..."></textarea>
            </div>
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">ğŸª ç‡Ÿæ¥­ç‹€æ…‹</h3>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="s-open" value="true"
                            class="w-4 h-4"> ç‡Ÿæ¥­ä¸­</label>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="s-open"
                            value="false" class="w-4 h-4"> ä¼‘æ¯ä¸­</label>
                </div>
            </div>
            <div class="text-center">
                <button onclick="saveSettings()" class="btn-primary">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div class="content-spacer"></div>
    </div>

    <!-- å•†å“ Modal -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="pm-title" class="text-xl font-bold mb-6" style="color:var(--primary)">æ–°å¢å•†å“</h3>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="pm-id">
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">åˆ†é¡ *</label><select id="pm-category"
                        class="input-field" required>
                        <option value="">é¸æ“‡åˆ†é¡</option>
                    </select></div>
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">å“å *</label><input type="text"
                        id="pm-name" class="input-field" required></div>
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">èªªæ˜</label><input type="text"
                        id="pm-desc" class="input-field" placeholder="é¢¨å‘³æè¿°"></div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="block text-sm text-gray-600 mb-1">åƒ¹æ ¼ *</label><input type="number" id="pm-price"
                            class="input-field" required min="0"></div>
                    <div><label class="block text-sm text-gray-600 mb-1">é‡é‡</label><input type="text" id="pm-weight"
                            class="input-field" placeholder="ä¾‹ï¼š227g"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="block text-sm text-gray-600 mb-1">ç”¢åœ°</label><input type="text" id="pm-origin"
                            class="input-field" placeholder="ä¾‹ï¼šè¡£ç´¢æ¯”äº"></div>
                    <div><label class="block text-sm text-gray-600 mb-1">çƒ˜ç„™åº¦</label><input type="text" id="pm-roast"
                            class="input-field" placeholder="ä¾‹ï¼šä¸­æ·ºç„™"></div>
                </div>
                <div class="mb-4"><label class="flex items-center gap-2"><input type="checkbox" id="pm-enabled" checked
                            class="w-4 h-4"> å•Ÿç”¨è²©å”®</label></div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-primary flex-1">å„²å­˜</button>
                    <button type="button" onclick="closeProductModal()"
                        class="flex-1 px-6 py-3 bg-gray-200 rounded-xl">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        //              ç³»çµ±è¨­å®šå€
        // ==========================================

        // 1ï¸âƒ£ Supabase API ç¶²å€ï¼ˆéƒ¨ç½²å¾Œæ›¿æ› YOUR_PROJECT_REFï¼‰
        const API_URL = 'https://avnvsjyyeofivgmrchte.supabase.co/functions/v1/coffee-api';

        // 2ï¸âƒ£ LINE Login Redirect URI
        const LINE_LOGIN_REDIRECT_URI = 'https://scriptcoffeeshop.github.io/sc/dashboard.html';

        // ==========================================
        let currentUser = null;
        let products = [];
        let categories = [];
        let orders = [];
        let users = [];
        let blacklist = [];

        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });

        function getAuthUserId() { if (!currentUser?.userId) throw new Error('è«‹å…ˆç™»å…¥'); return currentUser.userId; }

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            const p = new URLSearchParams(window.location.search);
            if (p.get('code')) handleLineCallback(p.get('code'), p.get('state'));
            else checkLogin();
        });

        // ============ LINE Login ============
        async function loginWithLine() {
            try {
                const r = await fetch(`${API_URL}?action=getLineLoginUrl&redirectUri=${encodeURIComponent(LINE_LOGIN_REDIRECT_URI)}`);
                const d = await r.json();
                if (d.success) { localStorage.setItem('coffee_admin_state', d.state); window.location.href = d.authUrl; }
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function handleLineCallback(code, state) {
            const saved = localStorage.getItem('coffee_admin_state');
            localStorage.removeItem('coffee_admin_state');
            if (!saved || state !== saved) { Swal.fire('é©—è­‰å¤±æ•—', 'è«‹é‡æ–°ç™»å…¥', 'error'); window.history.replaceState({}, '', 'dashboard.html'); return; }
            Swal.fire({ title: 'ç™»å…¥ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const r = await fetch(`${API_URL}?action=lineLogin&code=${encodeURIComponent(code)}&redirectUri=${encodeURIComponent(LINE_LOGIN_REDIRECT_URI)}`);
                const d = await r.json();
                window.history.replaceState({}, '', 'dashboard.html');
                if (d.success && d.isAdmin) {
                    currentUser = d.user; localStorage.setItem('coffee_admin', JSON.stringify(currentUser));
                    Swal.close(); showAdmin();
                } else { Swal.fire('éŒ¯èª¤', d.error || 'ç„¡ç®¡ç†å“¡æ¬Šé™', 'error'); }
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        function checkLogin() { const s = localStorage.getItem('coffee_admin'); if (s) { try { currentUser = JSON.parse(s); showAdmin(); } catch { localStorage.removeItem('coffee_admin'); } } }
        function logout() { localStorage.removeItem('coffee_admin'); currentUser = null; document.getElementById('login-page').classList.remove('hidden'); document.getElementById('admin-page').classList.add('hidden'); }

        async function showAdmin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            document.getElementById('admin-name').textContent = currentUser.displayName || 'ç®¡ç†å“¡';
            await Promise.all([loadCategories(), loadProducts()]);
            showTab('orders');
        }

        function showTab(tab) {
            ['orders', 'products', 'categories', 'settings', 'users', 'blacklist'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('bg-white', 'text-gray-600');
                document.getElementById(`${t}-section`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('bg-white', 'text-gray-600');
            document.getElementById(`${tab}-section`).classList.remove('hidden');
            if (tab === 'orders') loadOrders();
            else if (tab === 'settings') loadSettings();
            else if (tab === 'categories') renderCategories();
            else if (tab === 'users') loadUsers();
            else if (tab === 'blacklist') loadBlacklist();
        }

        // ============ è¨‚å–®ç®¡ç† ============
        async function loadOrders() {
            try {
                const r = await fetch(`${API_URL}?action=getOrders&userId=${getAuthUserId()}&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) { orders = d.orders; renderOrders(); }
            } catch (e) { console.error(e); }
        }

        function renderOrders() {
            const filter = document.getElementById('order-filter').value;
            const filtered = filter === 'all' ? orders : orders.filter(o => o.status === filter);
            const container = document.getElementById('orders-list');
            if (!filtered.length) { container.innerHTML = '<p class="text-center text-gray-500 py-8">æ²’æœ‰ç¬¦åˆçš„è¨‚å–®</p>'; return; }

            const statusLabel = { pending: 'å¾…è™•ç†', processing: 'è™•ç†ä¸­', shipped: 'å·²å‡ºè²¨', completed: 'å·²å®Œæˆ', cancelled: 'å·²å–æ¶ˆ' };
            const methodLabel = { delivery: 'ğŸ  å®…é…', seven_eleven: 'ğŸª 7-11', family_mart: 'ğŸ¬ å…¨å®¶' };

            container.innerHTML = filtered.map(o => {
                const time = new Date(o.timestamp).toLocaleString('zh-TW');
                const addrInfo = o.deliveryMethod === 'delivery'
                    ? `${o.city || ''}${o.district || ''} ${o.address || ''}`
                    : `${o.storeName || ''}${o.storeId ? ' [' + o.storeId + ']' : ''}${o.storeAddress ? ' (' + o.storeAddress + ')' : ''}`;
                return `
                <div class="border rounded-xl p-4 mb-3" style="border-color:#e5ddd5;">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm" style="color:var(--primary)">#${o.orderId}</span>
                            <span class="delivery-tag delivery-${o.deliveryMethod}">${methodLabel[o.deliveryMethod] || o.deliveryMethod}</span>
                            <span class="status-badge status-${o.status}">${statusLabel[o.status] || o.status}</span>
                        </div>
                        <span class="text-xs text-gray-500">${time}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                        <div><span class="text-gray-500">é¡§å®¢ï¼š</span>${esc(o.lineName)}</div>
                        <div><span class="text-gray-500">é›»è©±ï¼š</span>${esc(o.phone)}</div>
                        <div class="col-span-2"><span class="text-gray-500">ä¿¡ç®±ï¼š</span>${o.email ? `<a href="mailto:${esc(o.email)}" class="text-blue-500">${esc(o.email)}</a>` : 'ç„¡'}</div>
                        <div class="col-span-2"><span class="text-gray-500">åœ°å€/é–€å¸‚ï¼š</span>${esc(addrInfo)}</div>
                    </div>
                    <div class="text-sm text-gray-600 whitespace-pre-line bg-gray-50 p-3 rounded mb-2">${esc(o.items)}</div>
                    ${o.note ? `<div class="text-sm text-amber-700 bg-amber-50 p-2 rounded mb-2">ğŸ“ ${esc(o.note)}</div>` : ''}
                    <div class="flex justify-between items-center">
                        <span class="font-bold" style="color:var(--accent)">$${o.total}</span>
                        <div class="flex gap-2">
                            <select onchange="changeOrderStatus('${esc(o.orderId)}',this.value)" class="text-xs border rounded px-2 py-1">
                                ${['pending', 'processing', 'shipped', 'completed', 'cancelled'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${statusLabel[s]}</option>`).join('')}
                            </select>
                            <button onclick="deleteOrderById('${esc(o.orderId)}')" class="text-xs text-red-500 hover:text-red-700">åˆªé™¤</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function changeOrderStatus(orderId, status) {
            try {
                const r = await fetch(`${API_URL}?action=updateOrderStatus`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), orderId, status }) });
                const d = await r.json();
                if (d.success) { Toast.fire({ icon: 'success', title: 'ç‹€æ…‹å·²æ›´æ–°' }); loadOrders(); }
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function deleteOrderById(orderId) {
            const c = await Swal.fire({ title: 'åˆªé™¤è¨‚å–®ï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ' });
            if (!c.isConfirmed) return;
            try {
                const r = await fetch(`${API_URL}?action=deleteOrder`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), orderId }) });
                const d = await r.json();
                if (d.success) { Toast.fire({ icon: 'success', title: 'å·²åˆªé™¤' }); loadOrders(); }
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        // ============ å•†å“ç®¡ç† ============
        async function loadProducts() {
            try {
                const r = await fetch(`${API_URL}?action=getProducts&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) { products = d.products; renderProducts(); }
            } catch (e) { console.error(e); }
        }

        // å•†å“å¿«å–ï¼Œç”¨ ID æŸ¥æ‰¾é¿å…åœ¨ HTML onclick ä¸­å…§åµŒ JSON
        let productsMap = {};
        function renderProducts() {
            const tbody = document.getElementById('products-table');
            if (!products.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">å°šç„¡å•†å“</td></tr>'; return; }
            productsMap = {};
            products.forEach(p => { productsMap[p.id] = p; });
            tbody.innerHTML = products.map(p => `
                <tr class="border-b" style="border-color:#f0e6db;">
                    <td class="p-3 text-sm">${esc(p.category)}</td>
                    <td class="p-3"><div class="font-medium">${esc(p.name)}</div><div class="text-xs text-gray-500">${esc(p.description || '')} ${p.weight ? 'ãƒ»' + p.weight : ''} ${p.origin ? 'ãƒ»' + p.origin : ''}</div></td>
                    <td class="p-3 text-right font-medium">$${p.price}</td>
                    <td class="p-3 text-center"><span class="${p.enabled ? 'text-green-600' : 'text-gray-400'}">${p.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="editProduct(${p.id})" class="text-sm mr-2" style="color:var(--primary)">ç·¨è¼¯</button>
                        <button onclick="delProduct(${p.id})" class="text-sm text-red-500">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function showProductModal() {
            document.getElementById('pm-title').textContent = 'æ–°å¢å•†å“';
            document.getElementById('product-form').reset();
            document.getElementById('pm-id').value = '';
            document.getElementById('pm-enabled').checked = true;
            updateCategorySelect();
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function editProduct(id) {
            const p = productsMap[id];
            if (!p) { Swal.fire('éŒ¯èª¤', 'æ‰¾ä¸åˆ°å•†å“', 'error'); return; }
            document.getElementById('pm-title').textContent = 'ç·¨è¼¯å•†å“';
            document.getElementById('pm-id').value = p.id;
            updateCategorySelect();
            document.getElementById('pm-category').value = p.category;
            document.getElementById('pm-name').value = p.name;
            document.getElementById('pm-desc').value = p.description || '';
            document.getElementById('pm-price').value = p.price;
            document.getElementById('pm-weight').value = p.weight || '';
            document.getElementById('pm-origin').value = p.origin || '';
            document.getElementById('pm-roast').value = p.roastLevel || '';
            document.getElementById('pm-enabled').checked = p.enabled;
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }

        function updateCategorySelect() {
            const sel = document.getElementById('pm-category');
            sel.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>' + categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('pm-id').value;
            const payload = {
                userId: getAuthUserId(), category: document.getElementById('pm-category').value,
                name: document.getElementById('pm-name').value, description: document.getElementById('pm-desc').value,
                price: document.getElementById('pm-price').value, weight: document.getElementById('pm-weight').value,
                origin: document.getElementById('pm-origin').value, roastLevel: document.getElementById('pm-roast').value,
                enabled: document.getElementById('pm-enabled').checked,
            };
            if (id) payload.id = parseInt(id);
            try {
                const r = await fetch(`${API_URL}?action=${id ? 'updateProduct' : 'addProduct'}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const d = await r.json();
                if (d.success) { Toast.fire({ icon: 'success', title: id ? 'å·²æ›´æ–°' : 'å·²æ–°å¢' }); closeProductModal(); loadProducts(); }
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function delProduct(id) {
            const c = await Swal.fire({ title: 'åˆªé™¤å•†å“ï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ' });
            if (!c.isConfirmed) return;
            try {
                const r = await fetch(`${API_URL}?action=deleteProduct`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), id }) });
                const d = await r.json();
                if (d.success) { Toast.fire({ icon: 'success', title: 'å·²åˆªé™¤' }); loadProducts(); }
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        // ============ åˆ†é¡ç®¡ç† ============
        async function loadCategories() {
            try {
                const r = await fetch(`${API_URL}?action=getCategories&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) { categories = d.categories; renderCategories(); }
            } catch (e) { console.error(e); }
        }

        let categoriesMap = {};
        function renderCategories() {
            const container = document.getElementById('categories-list');
            if (!categories.length) { container.innerHTML = '<p class="text-center text-gray-500 py-4">å°šç„¡åˆ†é¡</p>'; return; }
            categoriesMap = {};
            categories.forEach(c => { categoriesMap[c.id] = c; });
            container.innerHTML = categories.map((c, i) => `
                <div class="flex items-center justify-between p-3 mb-2 rounded-lg" style="background:#faf6f2; border:1px solid #e5ddd5;">
                    <div class="flex items-center gap-2">
                        <button onclick="moveCategory(${c.id},'up')" class="text-gray-400 hover:text-amber-700 ${i === 0 ? 'opacity-30' : ''}" ${i === 0 ? 'disabled' : ''}>â–²</button>
                        <button onclick="moveCategory(${c.id},'down')" class="text-gray-400 hover:text-amber-700 ${i === categories.length - 1 ? 'opacity-30' : ''}" ${i === categories.length - 1 ? 'disabled' : ''}>â–¼</button>
                        <span class="font-medium">${esc(c.name)}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCategory(${c.id})" class="text-sm" style="color:var(--primary)">ç·¨è¼¯</button>
                        <button onclick="delCategory(${c.id})" class="text-sm text-red-500">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            if (!name) return;
            try {
                const r = await fetch(`${API_URL}?action=addCategory`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), name }) });
                const d = await r.json();
                if (d.success) { document.getElementById('new-cat-name').value = ''; Toast.fire({ icon: 'success', title: 'å·²æ–°å¢' }); loadCategories(); }
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function editCategory(id) {
            const cat = categoriesMap[id];
            if (!cat) { Swal.fire('éŒ¯èª¤', 'æ‰¾ä¸åˆ°åˆ†é¡', 'error'); return; }
            const oldName = cat.name;
            const { value } = await Swal.fire({ title: 'ä¿®æ”¹åˆ†é¡', input: 'text', inputValue: oldName, showCancelButton: true, confirmButtonText: 'æ›´æ–°', cancelButtonText: 'å–æ¶ˆ' });
            if (value && value !== oldName) {
                try {
                    const r = await fetch(`${API_URL}?action=updateCategory`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), id, name: value }) });
                    const d = await r.json();
                    if (d.success) { loadCategories(); loadProducts(); }
                } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
            }
        }

        async function delCategory(id) {
            const c = await Swal.fire({ title: 'åˆªé™¤åˆ†é¡ï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ' });
            if (!c.isConfirmed) return;
            try {
                const r = await fetch(`${API_URL}?action=deleteCategory`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), id }) });
                const d = await r.json();
                if (d.success) { loadCategories(); }
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function moveCategory(id, dir) {
            try {
                const r = await fetch(`${API_URL}?action=reorderCategory`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), id, direction: dir }) });
                const d = await r.json();
                if (d.success) loadCategories();
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        // ============ è¨­å®š ============
        async function loadSettings() {
            try {
                const r = await fetch(`${API_URL}?action=getSettings&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) {
                    const s = d.settings;
                    document.getElementById('s-ann-enabled').checked = String(s.announcement_enabled) === 'true';
                    document.getElementById('s-announcement').value = s.announcement || '';
                    const isOpen = String(s.is_open) !== 'false';
                    document.querySelector(`input[name="s-open"][value="${isOpen}"]`).checked = true;
                }
            } catch (e) { console.error(e); }
        }

        async function saveSettings() {
            try {
                const r = await fetch(`${API_URL}?action=updateSettings`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                        userId: getAuthUserId(),
                        settings: {
                            announcement_enabled: String(document.getElementById('s-ann-enabled').checked),
                            announcement: document.getElementById('s-announcement').value,
                            is_open: document.querySelector('input[name="s-open"]:checked')?.value || 'true',
                        }
                    })
                });
                const d = await r.json();
                if (d.success) Toast.fire({ icon: 'success', title: 'è¨­å®šå·²å„²å­˜' });
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        // ============ ç”¨æˆ¶ç®¡ç† ============
        async function loadUsers() {
            try {
                const search = document.getElementById('user-search').value;
                Swal.fire({ title: 'è¼‰å…¥ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const r = await fetch(`${API_URL}?action=getUsers&userId=${getAuthUserId()}&search=${encodeURIComponent(search)}&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) { users = d.users; renderUsers(); Swal.close(); }
                else { Swal.fire('éŒ¯èª¤', d.error, 'error'); }
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table');
            if (!users.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">ç„¡ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶</td></tr>'; return; }
            const isSuperAdmin = currentUser?.role === 'SUPER_ADMIN' || currentUser?.userId === 'U7cd3c1e2d837eed20fdcaed7ac6a4fa9'; // TODO: replace with exact validation if needed

            tbody.innerHTML = users.map(u => {
                const isUserSuperAdmin = u.role === 'SUPER_ADMIN';
                const isAdmin = u.role === 'ADMIN' || u.role === 'SUPER_ADMIN';
                const isBlocked = u.status === 'BLACKLISTED';
                const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleString('zh-TW') : 'ç„¡ç´€éŒ„';

                let actions = '';
                if (isBlocked) {
                    actions += `<button onclick="toggleUserBlacklist('${esc(u.userId)}', false)" class="text-green-600 hover:text-green-800 text-sm font-medium mr-3">è§£é™¤å°é–</button>`;
                } else {
                    actions += `<button onclick="toggleUserBlacklist('${esc(u.userId)}', true)" class="text-red-500 hover:text-red-700 text-sm font-medium mr-3">å°é–</button>`;
                }

                if (isSuperAdmin && !isUserSuperAdmin) {
                    if (isAdmin) actions += `<button onclick="toggleUserRole('${esc(u.userId)}', 'USER')" class="text-red-600 hover:text-red-800 text-sm font-medium">ç§»é™¤ç®¡ç†å“¡</button>`;
                    else actions += `<button onclick="toggleUserRole('${esc(u.userId)}', 'ADMIN')" class="text-purple-600 hover:text-purple-800 text-sm font-medium">è¨­ç‚ºç®¡ç†å“¡</button>`;
                }

                return `
                <tr class="border-b" style="border-color:#f0e6db;">
                    <td class="p-3"><img src="${esc(u.pictureUrl) || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border"></td>
                    <td class="p-3">
                        <div class="font-medium text-gray-800">${esc(u.displayName)}</div>
                        <div class="text-xs text-gray-500">${esc(u.email || '')} ${u.phone ? 'ãƒ»' + esc(u.phone) : ''}</div>
                        <div class="text-xs text-gray-500 mt-1">ğŸ  ${u.defaultDeliveryMethod === 'delivery' ? `å®…é… (${esc(u.defaultCity)}${esc(u.defaultDistrict)} ${esc(u.defaultAddress)})` :
                        u.defaultDeliveryMethod === 'in_store' ? 'ä¾†åº—è‡ªå–' :
                            u.defaultDeliveryMethod ? `${u.defaultDeliveryMethod === 'seven_eleven' ? '7-11' : 'å…¨å®¶'} (${esc(u.defaultStoreName)} - ${esc(u.defaultStoreId)})` : 'å°šæœªè¨­å®š'
                    }</div>
                        <div class="text-xs text-gray-400 font-mono mt-1 opacity-50">${esc(u.userId)}</div>
                    </td>
                    <td class="p-3">
                        <div>${isAdmin ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-purple-100 text-purple-800">ç®¡ç†å“¡</span>' : '<span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">ç”¨æˆ¶</span>'}</div>
                        <div class="mt-1">${isBlocked ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-800">é»‘åå–®</span>' : '<span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">æ­£å¸¸</span>'}</div>
                        <div class="text-xs text-gray-400 mt-1">ç™»å…¥ï¼š${lastLogin}</div>
                    </td>
                    <td class="p-3 text-right">${actions}</td>
                </tr>`;
            }).join('');
        }

        async function toggleUserRole(targetUserId, newRole) {
            const c = await Swal.fire({ title: `è¨­ç‚º ${newRole === 'ADMIN' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ç”¨æˆ¶'}ï¼Ÿ`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ç¢ºå®š' });
            if (!c.isConfirmed) return;
            try {
                Swal.fire({ title: 'è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const r = await fetch(`${API_URL}?action=updateUserRole`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), targetUserId, newRole }) });
                const d = await r.json();
                if (d.success) { Toast.fire({ icon: 'success', title: 'æ¬Šé™å·²æ›´æ–°' }); loadUsers(); }
                else throw new Error(d.error);
            } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
        }

        async function toggleUserBlacklist(targetUserId, isBlocked) {
            if (isBlocked) {
                const { value: reason } = await Swal.fire({ title: 'å°é–ç”¨æˆ¶', input: 'text', inputPlaceholder: 'è«‹è¼¸å…¥å°é–åŸå› ï¼ˆä¾‹å¦‚æƒ¡æ„æ£„å–®ï¼‰', showCancelButton: true, confirmButtonText: 'å°é–' });
                if (reason === undefined) return;
                try {
                    Swal.fire({ title: 'è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const r = await fetch(`${API_URL}?action=addToBlacklist`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), lineUserId: targetUserId, reason }) });
                    const d = await r.json();
                    if (d.success) { Toast.fire({ icon: 'success', title: 'å·²åŠ å…¥é»‘åå–®' }); loadUsers(); if (document.getElementById('tab-blacklist').classList.contains('tab-active')) loadBlacklist(); }
                    else throw new Error(d.error);
                } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
            } else {
                const c = await Swal.fire({ title: 'è§£é™¤å°é–ï¼Ÿ', icon: 'question', showCancelButton: true, confirmButtonText: 'ç¢ºå®šè§£é™¤' });
                if (!c.isConfirmed) return;
                try {
                    Swal.fire({ title: 'è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const r = await fetch(`${API_URL}?action=removeFromBlacklist`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: getAuthUserId(), lineUserId: targetUserId }) });
                    const d = await r.json();
                    if (d.success) { Toast.fire({ icon: 'success', title: 'å·²è§£é™¤å°é–' }); loadUsers(); if (document.getElementById('tab-blacklist').classList.contains('tab-active')) loadBlacklist(); }
                    else throw new Error(d.error);
                } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
            }
        }

        // ============ é»‘åå–® ============
        async function loadBlacklist() {
            try {
                const r = await fetch(`${API_URL}?action=getBlacklist&userId=${getAuthUserId()}&_=${Date.now()}`);
                const d = await r.json();
                if (d.success) { blacklist = d.blacklist; renderBlacklist(); }
            } catch (e) { console.error(e); }
        }

        function renderBlacklist() {
            const tbody = document.getElementById('blacklist-table');
            if (!blacklist.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">ç›®å‰æ²’æœ‰å°é–åå–®</td></tr>'; return; }
            tbody.innerHTML = blacklist.map(b => {
                const dt = b.blockedAt ? new Date(b.blockedAt).toLocaleString('zh-TW') : 'ç„¡ç´€éŒ„';
                return `
                <tr class="border-b" style="border-color:#f0e6db;">
                    <td class="p-3">
                        <div class="font-medium">${esc(b.displayName)}</div>
                        <div class="text-xs text-gray-400 font-mono">${esc(b.lineUserId)}</div>
                    </td>
                    <td class="p-3">
                        <div class="text-sm">${dt}</div>
                        <div class="text-xs text-red-500 mt-1">${esc(b.reason) || '(ç„¡åŸå› )'}</div>
                    </td>
                    <td class="p-3 text-right">
                        <button onclick="toggleUserBlacklist('${esc(b.lineUserId)}', false)" class="text-green-600 hover:text-green-800 text-sm font-medium">è§£é™¤å°é–</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function esc(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    </script>
</body>

</html>