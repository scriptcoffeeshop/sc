<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咖啡訂購 — 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body class="p-4 md:p-6">
    <!-- 登入頁 -->
    <div id="login-page" class="max-w-md mx-auto mt-20 glass-card p-8 text-center">
        <span class="text-5xl block mb-4">☕</span>
        <h1 class="text-2xl font-bold mb-2" style="color:var(--primary)">咖啡訂購後台</h1>
        <p class="text-gray-500 mb-6">僅限管理員登入</p>
        <button onclick="loginWithLine()"
            class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
            </svg>
            使用 LINE 登入
        </button>
    </div>

    <!-- 管理頁 -->
    <div id="admin-page" class="hidden max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">☕</span>
                <div>
                    <h1 class="text-xl font-bold" style="color:var(--primary)">咖啡訂購後台</h1>
                    <p class="text-sm text-gray-500">歡迎，<span id="admin-name"></span></p>
                </div>
            </div>
            <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500">登出</button>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button id="tab-orders" onclick="showTab('orders')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">📋
                訂單管理</button>
            <button id="tab-products" onclick="showTab('products')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">🫘
                商品管理</button>
            <button id="tab-categories" onclick="showTab('categories')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">📂
                分類管理</button>
            <button id="tab-settings" onclick="showTab('settings')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">⚙️
                系統設定</button>
            <button id="tab-formfields" onclick="showTab('formfields')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">📝
                表單管理</button>
            <button id="tab-users" onclick="showTab('users')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">👥
                用戶管理</button>
            <button id="tab-blacklist" onclick="showTab('blacklist')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-gray-600 whitespace-nowrap">🚫
                黑名單</button>
        </div>

        <!-- ===== 訂單管理 ===== -->
        <div id="orders-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">訂單列表</h2>
                <div class="flex gap-2 items-center">
                    <select id="order-filter" class="input-field text-sm py-1" style="width:auto"
                        onchange="renderOrders()">
                        <option value="all">全部</option>
                        <option value="pending">待處理</option>
                        <option value="processing">處理中</option>
                        <option value="shipped">已出貨</option>
                        <option value="completed">已完成</option>
                    </select>
                    <button onclick="loadOrders()" class="text-sm" style="color:var(--primary)">🔄 重整</button>
                </div>
            </div>
            <div id="orders-list">
                <p class="text-center text-gray-500 py-8">載入中...</p>
            </div>
        </div>

        <!-- ===== 商品管理 ===== -->
        <div id="products-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">咖啡豆商品</h2>
                <button onclick="showProductModal()" class="btn-primary text-sm">+ 新增商品</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="products-main-table">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left w-10" style="color:var(--primary)">排序</th>
                            <th class="p-3 text-left" style="color:var(--primary)">分類</th>
                            <th class="p-3 text-left" style="color:var(--primary)">品名</th>
                            <th class="p-3 text-right" style="color:var(--primary)">價格</th>
                            <th class="p-3 text-center" style="color:var(--primary)">狀態</th>
                            <th class="p-3 text-center" style="color:var(--primary)">操作</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== 分類管理 ===== -->
        <div id="categories-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">商品分類</h2>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-cat-name" class="input-field flex-grow" placeholder="新分類名稱">
                <button onclick="addCategory()" class="btn-primary text-sm">新增</button>
            </div>
            <div id="categories-list"></div>
        </div>

        <!-- ===== 用戶管理 ===== -->
        <div id="users-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">用戶管理</h2>
                <div class="flex gap-2 items-center">
                    <input type="text" id="user-search" class="input-field text-sm py-1" placeholder="搜尋名稱/手機/Email"
                        onkeyup="if(event.key==='Enter') loadUsers()">
                    <button onclick="loadUsers()" class="btn-primary text-sm py-1 px-4">搜尋</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left w-12" style="color:var(--primary)">頭像</th>
                            <th class="p-3 text-left" style="color:var(--primary)">用戶資訊</th>
                            <th class="p-3 text-left" style="color:var(--primary)">角色與狀態</th>
                            <th class="p-3 text-right" style="color:var(--primary)">操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr>
                            <td colspan="4" class="text-center py-8 text-gray-500">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== 黑名單 ===== -->
        <div id="blacklist-section" class="glass-card p-6 hidden">
            <h2 class="text-lg font-bold mb-4" style="color:var(--primary)">黑名單</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2" style="border-color:var(--secondary)">
                            <th class="p-3 text-left" style="color:var(--primary)">用戶名稱</th>
                            <th class="p-3 text-left" style="color:var(--primary)">封鎖時間與原因</th>
                            <th class="p-3 text-right" style="color:var(--primary)">操作</th>
                        </tr>
                    </thead>
                    <tbody id="blacklist-table">
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== 系統設定 ===== -->
        <div id="settings-section" class="glass-card p-6 hidden">
            <h2 class="text-lg font-bold mb-6" style="color:var(--primary)">系統設定</h2>

            <!-- 品牌設定 -->
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">☕ 品牌設定</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">網站標題</label>
                        <input type="text" id="s-site-title" class="input-field" placeholder="咖啡豆訂購">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">副標題</label>
                        <input type="text" id="s-site-subtitle" class="input-field" placeholder="新鮮烘焙・產地直送">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">預設 Emoji 圖示</label>
                        <input type="text" id="s-site-emoji" class="input-field" placeholder="☕">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">上傳自訂 Icon（將取代 Emoji）</label>
                        <div class="flex gap-2 items-center">
                            <input type="file" id="s-icon-file" accept="image/*" class="text-sm"
                                onchange="previewIcon(this)">
                            <img id="s-icon-preview" src="" alt="" class="w-8 h-8 rounded hidden object-cover">
                            <button onclick="uploadSiteIcon()" class="btn-primary text-xs py-1 px-3">上傳</button>
                        </div>
                        <p id="s-icon-url-display" class="text-xs text-gray-400 mt-1 truncate"></p>
                    </div>
                </div>
            </div>

            <!-- 區塊標題 -->
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">🏷️ 區塊標題樣式設定</h3>

                <!-- 商品區塊 -->
                <div class="mb-4 border-b pb-4" style="border-color:#f0e6db">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">商品區塊</label>
                        <button type="button" onclick="resetSectionTitle('products')"
                            class="text-xs text-blue-500 hover:text-blue-700">恢復預設</button>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="s-products-title" class="input-field flex-1 min-w-[150px]"
                            placeholder="🪶 咖啡豆選購">
                        <input type="color" id="s-products-color" value="#6F4E37"
                            class="h-10 w-10 cursor-pointer rounded border border-gray-300 p-0.5" title="文字顏色">
                        <select id="s-products-size" class="input-field w-24" title="文字大小">
                            <option value="text-base">16px (標準)</option>
                            <option value="text-lg">18px (稍大)</option>
                            <option value="text-xl">20px (大)</option>
                            <option value="text-2xl">24px (特大)</option>
                        </select>
                        <label
                            class="flex items-center gap-1 cursor-pointer bg-gray-50 px-3 py-2 rounded border border-gray-200"><input
                                type="checkbox" id="s-products-bold"> 粗體</label>
                    </div>
                </div>

                <!-- 配送區塊 -->
                <div class="mb-4 border-b pb-4" style="border-color:#f0e6db">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">配送區塊</label>
                        <button type="button" onclick="resetSectionTitle('delivery')"
                            class="text-xs text-blue-500 hover:text-blue-700">恢復預設</button>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="s-delivery-title" class="input-field flex-1 min-w-[150px]"
                            placeholder="🚚 配送方式">
                        <input type="color" id="s-delivery-color" value="#6F4E37"
                            class="h-10 w-10 cursor-pointer rounded border border-gray-300 p-0.5" title="文字顏色">
                        <select id="s-delivery-size" class="input-field w-24" title="文字大小">
                            <option value="text-base">16px (標準)</option>
                            <option value="text-lg">18px (稍大)</option>
                            <option value="text-xl">20px (大)</option>
                            <option value="text-2xl">24px (特大)</option>
                        </select>
                        <label
                            class="flex items-center gap-1 cursor-pointer bg-gray-50 px-3 py-2 rounded border border-gray-200"><input
                                type="checkbox" id="s-delivery-bold"> 粗體</label>
                    </div>
                </div>

                <!-- 備註區塊 -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">備註區塊</label>
                        <button type="button" onclick="resetSectionTitle('notes')"
                            class="text-xs text-blue-500 hover:text-blue-700">恢復預設</button>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="s-notes-title" class="input-field flex-1 min-w-[150px]"
                            placeholder="📝 訂單備註">
                        <input type="color" id="s-notes-color" value="#6F4E37"
                            class="h-10 w-10 cursor-pointer rounded border border-gray-300 p-0.5" title="文字顏色">
                        <select id="s-notes-size" class="input-field w-24" title="文字大小">
                            <option value="text-base">16px (標準)</option>
                            <option value="text-lg">18px (稍大)</option>
                            <option value="text-xl">20px (大)</option>
                            <option value="text-2xl">24px (特大)</option>
                        </select>
                        <label
                            class="flex items-center gap-1 cursor-pointer bg-gray-50 px-3 py-2 rounded border border-gray-200"><input
                                type="checkbox" id="s-notes-bold"> 粗體</label>
                    </div>
                </div>
            </div>

            <!-- 公告 -->
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">📢 公告設定</h3>
                <label class="flex items-center gap-2 mb-3 cursor-pointer">
                    <input type="checkbox" id="s-ann-enabled" class="w-4 h-4"> <span>啟用公告</span>
                </label>
                <textarea id="s-announcement" class="input-field resize-none" rows="3" placeholder="公告內容..."></textarea>
            </div>

            <!-- 營業狀態 -->
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">🏪 營業狀態</h3>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="s-open" value="true"
                            class="w-4 h-4"> 營業中</label>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="s-open"
                            value="false" class="w-4 h-4"> 休息中</label>
                </div>
            </div>

            <!-- 金流設定（預留） -->
            <div class="mb-6 p-4 bg-white rounded-xl border" style="border-color:#e5ddd5">
                <h3 class="font-semibold mb-3" style="color:var(--primary)">💳 金流設定（預留）</h3>
                <p class="text-sm text-gray-500 mb-3">此區塊將於未來串接金流服務時啟用</p>
                <label class="flex items-center gap-2 mb-3 cursor-pointer">
                    <input type="checkbox" id="s-payment-enabled" class="w-4 h-4" disabled> <span
                        class="text-gray-400">啟用線上付款（尚未開放）</span>
                </label>
            </div>

            <div class="text-center">
                <button onclick="saveSettings()" class="btn-primary">儲存設定</button>
            </div>
        </div>

        <!-- ===== 表單管理 ===== -->
        <div id="formfields-section" class="glass-card p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold" style="color:var(--primary)">表單欄位管理</h2>
                <button onclick="showAddFieldModal()" class="btn-primary text-sm">+ 新增欄位</button>
            </div>
            <p class="text-sm text-gray-500 mb-4">管理前台訂購表單的自訂欄位（如聯絡電話、電子郵件、開立收據等）。可拖拽排序、設定必填、啟用/停用。</p>
            <div id="formfields-list">
                <p class="text-center text-gray-500 py-8">載入中...</p>
            </div>
        </div>

        <div class="content-spacer"></div>
    </div>

    <!-- 商品 Modal -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="pm-title" class="text-xl font-bold mb-6" style="color:var(--primary)">新增商品</h3>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="pm-id">
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">分類 *</label><select id="pm-category"
                        class="input-field" required>
                        <option value="">選擇分類</option>
                    </select></div>
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">品名 *</label><input type="text"
                        id="pm-name" class="input-field" required></div>
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">說明</label><input type="text"
                        id="pm-desc" class="input-field" placeholder="風味描述"></div>
                <div class="mb-3"><label class="block text-sm text-gray-600 mb-1">烘焙度</label><input type="text"
                        id="pm-roast" class="input-field" placeholder="例：中淺焙"></div>

                <!-- 規格與價格 -->
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-2 font-semibold">📦 規格與價格</label>
                    <div id="specs-container" class="space-y-2"></div>
                    <button type="button" onclick="addSpecRow()" class="mt-2 text-sm font-medium hover:underline"
                        style="color:var(--primary)">+ 新增規格</button>
                </div>

                <div class="mb-4"><label class="flex items-center gap-2"><input type="checkbox" id="pm-enabled" checked
                            class="w-4 h-4"> 啟用販售</label></div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-primary flex-1">儲存</button>
                    <button type="button" onclick="closeProductModal()"
                        class="flex-1 px-6 py-3 bg-gray-200 rounded-xl">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="js/dashboard-app.js?v=3"></script>
</body>

</html>