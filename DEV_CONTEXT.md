# 咖啡訂購系統 - 開發脈絡與狀態紀錄 (Context Tracking)

**這份文件用來記錄專案最近的重要變更、除錯經驗與排版設計決策建立的脈絡。**
為了方便下次進行專案開發或開啟新對話時，讓 AI（Assistant）能快速掌握目前狀態與曾經踩過的坑。

---

## 📅 近期重要更新 (v10 階段)

### 1. TypeScript 與模組修復
- **Deno / Zod 問題**：修正了 `fix_ts.ts` 腳本中因為 Deno 未宣告導致的 TypeScript 錯誤（補上 `declare const Deno: any;`）；替 Supabase Edge Functions (`settings.ts`) 引入的 `zod` 加上 `@ts-ignore` 消除編輯器層級的找不到模組報錯（不影響執行）。

### 2. 移除底部確認送出按鈕 (UI 簡化)
- **變更點**：為了簡化行動版底部版面，將 `main.html` 在畫面底部的「確認送出」按鈕徹底移除。
- **後續影響與踩坑紀錄**：
  - **空值報錯 (Null Reference)**：因為移除了按鈕，原有的 `js/main-app.js` 舊程式碼在使用者登入或切換狀態時，因為找不到 `submitBtn` 而發生了 `null is not an object` TypeError，導致頁面登入崩潰。
  - **嚴重的 Cache (快取) 問題**：由於手機版瀏覽器與 LINE 內建瀏覽器的快取極強，即便更新了防呆（`if(submitBtn)`），前端依然會拿舊版 JS 配新版 HTML，因此一再當機。
  - **最終解決方案**：
    1. 在 `main.html` 放入一顆幽靈按鈕（隱藏的 `#submit-btn` 加上 `display: none;`），做為相容舊版快取 JS 的安全降落區塊。
    2. 無論何時修改 JS，**務必要更新** `main.html` 裡面 `src="js/main-app.js?v=XX"` 的版號，這幾次下來已經推進到 `v=10`。

### 3. 加入購物車折扣細項與視覺化
- **UI 變更**：原本滿額折扣只顯示在底部。現在購物車打開後，`cart-discount-details` 區塊中會清楚列出每一筆套用的活動與扣除金額（例如：`🏷️ 全館滿千折百 -$100`）。
- **標籤功能**：`cart.js` 的 `calcPromotions` 中計算哪些項目適用折扣後，符合條件的商品右側會被打上 `[適用優惠]` 的紅色小 Badge。

### 4. 手機版商品規格 Stepper 文字遮擋排版問題
- **問題描述**：原本商品清單的按鈕裡，同時塞了規格名稱和 `[ - 1 + ]` 計算器。在手機看時文字會被擠壓成如「半...」、「單...」等無法辨識的狀態。
- **設計嘗試與決定 (方案 A 落定)**：
  - 曾經嘗試**方案 C (底部滑出 Drawer)**，但在開發上線後認為體驗不如預期而快速透過 `git revert` 撤銷。
  - **現行方案 A**：當商品加入購物車後，該顆操作按鈕會在原地從一行「長高為上下兩行」。上半部維持原本的名稱與價格文字，下半部專心放增減數量的 `− [數值] +` 按鈕，從此不互相擠壓；並藉由這顆數量文字，捨棄了原本按鈕外部的紅點數量標籤，使畫面更清爽。

### 5. Git 版本控制規範調整
- **現行規則**：在開發過程中，先將 `.gitignore` 的 `#supabase/` 短暫註解掉（允許 Push），目的是讓本機更改的設定可以推到 GitHub 上備份。未來專案確認完成後，應執行特殊的 cleanup 刪除不需要部署至 Pages 的檔案。

---

## 🛠 給協助審查或接手此專案的 AI 的注意事項

1. **不可輕忽的手機 Cache**：未來如果修改了 js 代碼但畫面邏輯崩潰，請高度懷疑是瀏覽器快取搗亂。解法是：**只要動了 js，就必須同時修改 `.html` 引用的 `v=X` 版號**。
2. **Global Window Functions**：因為當前的實作包含了很多寫在 `.html` 原生的 `onclick="window.xxx()"` 事件，因此如果在 module 裡面新寫了函數（如 `openSpecDrawer` 等），務必記得去 `main-app.js` 全局綁定給 `window`。
3. **繁體中文規則**：所有對話與代碼內的開發邏輯註解（comments），依照過去的強制要求，請一律使用 **「繁體中文（Traditional Chinese）」**。
